generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  CONDUCTOR
}

enum Status {
  OPEN
  ANALYZING
  PENDING_REVIEW // Admin reviewing solution candidates
  PENDING_CONDUCTOR // Solution sent, waiting for conductor acknowledgment
  RESOLVED // Conductor acknowledged and took action
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model User {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email    String   @unique
  password String
  role     UserRole @default(CONDUCTOR)
  name     String?

  trainId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports  Report[] @relation("Reporter")
  resolved Report[] @relation("Resolver")
}

model Report {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // input
  content  String
  imageUrl String[]
  location String

  trainId String?

  urgency Urgency @default(MEDIUM)
  status  Status  @default(OPEN)

  // output
  solution   Solution?
  candidates SolutionCandidate[] // Solution candidates for admin review

  // relations
  conductorId String @db.Uuid
  conductor   User   @relation("Reporter", fields: [conductorId], references: [id])

  adminId String? @db.Uuid
  admin   User?   @relation("Resolver", fields: [adminId], references: [id])
}

model Solution {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())

  title String
  steps String

  source      String
  confidence  Float?
  isGoldenRun Boolean @default(false)

  // Multimodal RAG metadata
  retrievalMethod  String? // "multimodal" | "text-only" | "fallback"
  embeddingModel   String? // "openclip-ViT-L-14" | "gemini-embedding-004"
  similarityScore  Float? // Top match score from vector search
  retrievedSources Json? // Array of similar incident IDs with scores

  // Solution workflow tracking
  confirmedAt    DateTime? // When admin confirmed the solution
  acknowledgedAt DateTime? // When conductor acknowledged receipt

  // relations
  reportId String @unique @db.Uuid
  report   Report @relation(fields: [reportId], references: [id])
}

// Temporary storage for solution candidates before admin selection
model SolutionCandidate {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt DateTime @default(now())

  title  String
  steps  String
  action String // Original action from Qdrant
  detail String // Original detail from Qdrant

  score Float // Similarity score (confidence)
  rank  Int // 1, 2, or 3 (1 = best match)

  sourceId  Int // Original incident ID from Qdrant
  avgDelay  Int? // Average delay from similar incidents
  timesUsed Int? // How many times this solution was used

  // relations
  reportId String @db.Uuid
  report   Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
}
